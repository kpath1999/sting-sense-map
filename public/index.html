<!DOCTYPE html>
<html>
<head>
    <title>Bus Route Driving Behavior Analysis</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100vw; }
        .leaflet-control-layers {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            position: absolute !important;
            top: 20px !important;
            right: 10px !important;
            z-index: 1000;
            min-width: 180px;
        }
        .leaflet-control-layers-base label, .leaflet-control-layers-overlays label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .leaflet-control-layers span[style*="background-color"] {
            margin-right: 10px;
        }
        /* Enhanced popup styling */
        .leaflet-popup-content {
            margin: 8px 12px;
            line-height: 1.4;
            font-size: 13px;
            font-family: Arial, sans-serif;
        }
        .popup-section {
            margin-bottom: 12px;
        }
        .popup-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 6px;
            padding-bottom: 3px;
            border-bottom: 1px solid #ddd;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        .data-label {
            font-weight: 500;
            color: #555;
        }
        .data-value {
            color: #333;
            font-family: 'Courier New', monospace;
        }
        .highlight-value {
            background-color: #f0f8ff;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        .behavior-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
        }
        /* New styles for summary button and modal */
        .summary-button {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1100;
            padding: 10px 20px;
            background-color: #2c7bb6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }
        .summary-button:hover {
            background-color: #1a5f8c;
        }
        .summary-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .summary-content {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
        }
        .summary-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c7bb6;
            border-bottom: 2px solid #2c7bb6;
            padding-bottom: 10px;
        }
        .summary-section {
            margin-bottom: 20px;
        }
        .summary-section h3 {
            color: #555;
            margin-bottom: 10px;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        .close-button:hover {
            color: #333;
        }
    </style>
</head>
<body>

<div id="map"></div>
<button class="summary-button" onclick="generateSummary()">Generate Summary</button>
<div class="modal-overlay" id="modalOverlay"></div>
<div class="summary-modal" id="summaryModal">
    <button class="close-button" onclick="closeSummary()">&times;</button>
    <div class="summary-content" id="summaryContent">
        <div class="summary-header">Route Analysis Summary</div>
        <div id="summaryText">Generating summary...</div>
    </div>
</div>

<script>
    var map = L.map('map').setView([33.776, -84.389], 15);
    var allData = []; // Store all data points for analysis

    var baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // --- Updated Data Configuration for Behavior-Based Clustering ---
    const behaviorTypes = ['Calm', 'Moderate', 'Slightly Unstable', 'Aggressive', 'Very Aggressive'];
    const behaviorColors = {
        'Calm': '#2c7bb6',
        'Moderate': '#abd9e9', 
        'Slightly Unstable': '#ffffbf',
        'Aggressive': '#fdae61',
        'Very Aggressive': '#d7191c'
    };

    // Create an object to hold our layer groups, one for each behavior type
    const overlayLayers = {};
    
    // Create a Layer Group for each behavior type and add it to the map by default
    behaviorTypes.forEach(behavior => {
        const color = behaviorColors[behavior];
        const layerName = `<span style="background-color:${color}; padding: 1px 8px; border-radius: 3px;">&nbsp;</span> ${behavior}`;
        
        // Create an empty layer group for this behavior
        overlayLayers[layerName] = L.layerGroup().addTo(map);
    });

    // --- Data Loading and Processing ---
    fetch('bus_route_with_clusters.geojson')
        .then(response => response.json())
        .then(data => {
            // Store all data points for analysis
            allData = data.features;

            // Process each feature and add it to the correct layer group
            data.features.forEach((feature, index) => {
                const props = feature.properties;
                const behavior = props.behavior;
                const color = props.color;
                
                const marker = L.circleMarker(
                    [feature.geometry.coordinates[1], feature.geometry.coordinates[0]],
                    {
                        radius: 6,
                        fillColor: color,
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }
                );

                // Build comprehensive popup content
                const popupContent = `
                    <div style="width: 320px; max-height: 400px; overflow-y: auto;">
                        <!-- Header Section -->
                        <div class="popup-section">
                            <div style="text-align: center; margin-bottom: 10px;">
                                <span class="behavior-badge" style="background-color: ${color};">${behavior} Driving</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Timestamp:</span>
                                <span class="data-value">${props.timestamp}</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Location:</span>
                                <span class="data-value">${feature.geometry.coordinates[1].toFixed(6)}, ${feature.geometry.coordinates[0].toFixed(6)}</span>
                            </div>
                        </div>

                        <!-- Clustering Analysis Section -->
                        <div class="popup-section">
                            <div class="popup-header">🎯 Clustering Analysis</div>
                            <div class="data-row">
                                <span class="data-label">Cluster ID:</span>
                                <span class="data-value highlight-value">${props.cluster}</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Extreme Event Magnitude:</span>
                                <span class="data-value highlight-value">${props.extreme_event_magnitude.toFixed(4)} m/s²</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Instability Score:</span>
                                <span class="data-value highlight-value">${props.instability_score.toFixed(4)} (m/s²)²</span>
                            </div>
                        </div>

                        <!-- Basic Acceleration Statistics -->
                        <div class="popup-section">
                            <div class="popup-header">📊 Basic Acceleration Statistics</div>
                            <div class="data-row">
                                <span class="data-label">Mean Acceleration:</span>
                                <span class="data-value">${props.accel_mean.toFixed(4)} m/s²</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Acceleration Variance:</span>
                                <span class="data-value">${props.accel_variance.toFixed(4)} (m/s²)²</span>
                            </div>
                        </div>

                        <!-- X-Axis Acceleration Statistics -->
                        <div class="popup-section">
                            <div class="popup-header">📈 X-Axis Acceleration Percentiles</div>
                            <div class="data-row">
                                <span class="data-label">1st Percentile (p1):</span>
                                <span class="data-value">${props.accel_stats_x_p1.toFixed(4)} m/s²</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">10th Percentile (p10):</span>
                                <span class="data-value">${props.accel_stats_x_p10.toFixed(4)} m/s²</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">90th Percentile (p90):</span>
                                <span class="data-value">${props.accel_stats_y_p90.toFixed(4)} m/s²</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">99th Percentile (p99):</span>
                                <span class="data-value highlight-value">${props.accel_stats_x_p99.toFixed(4)} m/s²</span>
                            </div>
                        </div>

                        <!-- Y-Axis Acceleration Statistics -->
                        <div class="popup-section">
                            <div class="popup-header">📈 Y-Axis Acceleration Percentiles</div>
                            <div class="data-row">
                                <span class="data-label">1st Percentile (p1):</span>
                                <span class="data-value">${props.accel_stats_y_p1.toFixed(4)} m/s²</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">10th Percentile (p10):</span>
                                <span class="data-value">${props.accel_stats_y_p10.toFixed(4)} m/s²</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">90th Percentile (p90):</span>
                                <span class="data-value">${props.accel_stats_y_p90.toFixed(4)} m/s²</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">99th Percentile (p99):</span>
                                <span class="data-value highlight-value">${props.accel_stats_y_p99.toFixed(4)} m/s²</span>
                            </div>
                        </div>

                        <!-- Z-Axis Acceleration Statistics -->
                        <div class="popup-section">
                            <div class="popup-header">📈 Z-Axis Acceleration Percentiles</div>
                            <div class="data-row">
                                <span class="data-label">1st Percentile (p1):</span>
                                <span class="data-value">${props.accel_stats_z_p1.toFixed(4)} m/s²</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">10th Percentile (p10):</span>
                                <span class="data-value">${props.accel_stats_z_p10.toFixed(4)} m/s²</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">90th Percentile (p90):</span>
                                <span class="data-value">${props.accel_stats_z_p90.toFixed(4)} m/s²</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">99th Percentile (p99):</span>
                                <span class="data-value highlight-value">${props.accel_stats_z_p99.toFixed(4)} m/s²</span>
                            </div>
                        </div>

                        <!-- AI Insight Section -->
                        <div class="popup-section">
                            <div class="popup-header">🤖 AI Insight</div>
                            <div id="ai-insight-${index}" style="font-size: 12px; color: #333; line-height: 1.4; min-height: 40px; padding: 5px; background-color: #f7f7f7; border-radius: 3px;">
                                Click the button for an AI-powered explanation.
                            </div>
                            <button id="ai-insight-btn-${index}" onclick='getAiInsight(${index})' style="margin-top: 10px; padding: 6px 12px; background-color: #2c7bb6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">Get AI Insight</button>
                        </div>

                        <!-- Interpretation Section -->
                        <div class="popup-section">
                            <div class="popup-header">🔍 Data Interpretation</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.3;">
                                <strong>Extreme Event Magnitude:</strong> Combined 3D acceleration vector magnitude from 99th percentiles - higher values indicate more severe acceleration events.<br><br>
                                <strong>Instability Score:</strong> Acceleration variance - higher values indicate more erratic or jerky motion.<br><br>
                                <strong>Percentiles:</strong> p1/p10 show typical low values, p90/p99 show extreme high values for each axis.
                            </div>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent, {
                    maxWidth: 350,
                    maxHeight: 450
                });
                
                // Find the correct layer group by behavior name and add the marker
                const layerKey = Object.keys(overlayLayers).find(key => key.includes(behavior));
                if (layerKey) {
                    overlayLayers[layerKey].addLayer(marker);
                }
            });

            // Fit map to the bounds of all features
            const allPointsLayer = L.geoJSON(data);
            if (allPointsLayer.getBounds().isValid()) {
                map.fitBounds(allPointsLayer.getBounds());
            }
        })
        .catch(error => {
            console.error('Error loading GeoJSON:', error);
            alert('Error loading bus data. Please check that your GeoJSON file is accessible.');
        });

    // Add the layer control panel to the map
    L.control.layers(null, overlayLayers, { collapsed: false }).addTo(map);

    // Add these functions for summary generation
    function showSummaryModal() {
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('summaryModal').style.display = 'block';
    }

    function closeSummary() {
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('summaryModal').style.display = 'none';
    }

    async function getAiInsight(index) {
        const feature = allData[index];
        const props = feature.properties;
        const insightContainer = document.getElementById(`ai-insight-${index}`);
        const insightButton = document.getElementById(`ai-insight-btn-${index}`);

        if (!feature) {
            insightContainer.innerHTML = 'Error: Data not found.';
            return;
        }

        insightButton.disabled = true;
        insightButton.textContent = 'Analyzing...';
        insightContainer.innerHTML = 'Generating AI insight, please wait...';

        // Construct a detailed prompt for the LLM
        const prompt = `
            Analyze the following bus telematics data point and provide a brief, likely explanation for the event. The location is on a university campus (Georgia Tech).
            - Timestamp: ${props.timestamp}
            - Location: ${feature.geometry.coordinates[1].toFixed(5)}, ${feature.geometry.coordinates[0].toFixed(5)}
            - Behavior Cluster: '${props.behavior}'
            - Instability Score (variance): ${props.instability_score.toFixed(4)}
            - Extreme Event Magnitude: ${props.extreme_event_magnitude.toFixed(4)}
            - Acceleration 99th Percentiles:
              - X-axis (lateral): ${props.accel_stats_x_p99.toFixed(4)} m/s²
              - Y-axis (longitudinal): ${props.accel_stats_y_p99.toFixed(4)} m/s²
              - Z-axis (vertical): ${props.accel_stats_z_p99.toFixed(4)} m/s²
            
            Based on these metrics and the campus environment, what is the most likely cause? (e.g., sudden braking for a pedestrian, sharp turn, speed bump, pothole, normal acceleration/deceleration). Be concise and clear.
        `;

        try {
            const response = await fetch('/api/generate-insight', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });

            if (!response.ok) {
                throw new Error('Failed to get AI insight from server.');
            }

            const data = await response.json();
            const insight = data.choices[0].message.content;

            insightContainer.innerHTML = insight;
            insightButton.style.display = 'none'; // Hide button after success

        } catch (error) {
            console.error('Error getting AI insight:', error);
            insightContainer.innerHTML = 'Sorry, unable to generate an insight at this time. Please try again later.';
            insightButton.disabled = false;
            insightButton.textContent = 'Get AI Insight';
        }
    }

    async function generateSummary() {
        showSummaryModal();
        const summaryText = document.getElementById('summaryText');
        summaryText.innerHTML = 'Generating summary...';

        try {
            // Create a prompt based on the data
            const prompt = `Write a 200-word analysis of traffic conditions around Georgia Tech's campus based on this data. Focus on specific locations and explain the driving behavior patterns you observe. For example, if you notice aggressive driving in an area, explain why you think this might be happening (e.g., frequent stops, road conditions, traffic patterns). Be specific about locations like Midtown, Ferst Drive, Tech Square, etc. Format as a single, flowing paragraph in plain text without any special formatting.

Data points: ${allData.length}
Behavior types: ${behaviorTypes.join(', ')}`;

            const response = await fetch('/api/generate-summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ prompt })
            });

            if (!response.ok) {
                throw new Error('Failed to generate summary');
            }

            const data = await response.json();
            const summary = data.choices[0].message.content;
            
            // Display the summary as plain text
            summaryText.innerHTML = `<p style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">${summary}</p>`;
        } catch (error) {
            console.error('Error generating summary:', error);
            summaryText.innerHTML = `
                <div style="color: #d7191c; padding: 10px; background-color: #f8d7da; border-radius: 4px;">
                    <p>Failed to generate summary. Please try again later.</p>
                    <p style="font-size: 0.9em;">Error: ${error.message}</p>
                </div>
            `;
        }
    }
</script>

</body>
</html> 